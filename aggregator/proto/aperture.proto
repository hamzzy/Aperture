syntax = "proto3";

package aperture.aggregator.v1;

// Aggregator service: receives profile data from agents and supports queries.
service Aggregator {
  // Push a batch of profile events from an agent.
  rpc Push(PushRequest) returns (PushResponse);
  // Query in-memory buffer (recent batches, by agent).
  rpc Query(QueryRequest) returns (QueryResponse);
  // Query persistent storage (time range, agent filter).
  rpc QueryStorage(QueryStorageRequest) returns (QueryResponse);
  // Aggregate events across batches into merged profiles
  rpc Aggregate(AggregateRequest) returns (AggregateResponse);
  // Differential profiling: compare two time windows or agents.
  rpc Diff(DiffRequest) returns (DiffResponse);
}

message PushRequest {
  string agent_id = 1;
  uint64 sequence = 2;
  bytes payload = 3;  // bincode-serialized aperture_shared::protocol::wire::Message
}

message PushResponse {
  bool ok = 1;
  string error = 2;
  bool backpressure = 3;  // true when buffer utilization > 80%
}

message QueryRequest {
  optional string agent_id = 1;  // filter by agent; empty = all
  uint32 limit = 2;              // max batches to return (default 100)
}

message QueryStorageRequest {
  optional string agent_id = 1;
  optional int64 time_start_ns = 2;  // Unix epoch nanoseconds
  optional int64 time_end_ns = 3;
  uint32 limit = 4;
}

message BatchInfo {
  string agent_id = 1;
  uint64 sequence = 2;
  uint64 event_count = 3;
  int64 received_at_ns = 4;
}

message QueryResponse {
  repeated BatchInfo batches = 1;
  string error = 2;  // set if query failed
}

// ── Aggregate RPC ───────────────────────────────────────────────────────────

message AggregateRequest {
  optional string agent_id = 1;
  optional int64 time_start_ns = 2;
  optional int64 time_end_ns = 3;
  uint32 limit = 4;        // max batches to aggregate (default 1000)
  string event_type = 5;   // "cpu", "lock", "syscall", or "" for all
}

message AggregateResponse {
  string result_json = 1;  // JSON-serialized AggregateResult
  uint64 total_events = 2;
  string error = 3;
}

// ── Diff RPC ────────────────────────────────────────────────────────────────

message DiffRequest {
  // Baseline window
  optional string baseline_agent_id = 1;
  optional int64 baseline_start_ns = 2;
  optional int64 baseline_end_ns = 3;
  // Comparison window
  optional string comparison_agent_id = 4;
  optional int64 comparison_start_ns = 5;
  optional int64 comparison_end_ns = 6;
  string event_type = 7;   // "cpu", "lock", "syscall"
  uint32 limit = 8;        // max batches per window (default 1000)
}

message DiffResponse {
  string result_json = 1;  // JSON-serialized CpuDiff / SyscallDiff / LockDiff
  string error = 2;
}
